<conversation xmlns="urn:Test.Namespace">
    <branch name="default">
        <addcharacter name="game" animations=""/>
        <setname name="game" displayname=""/>
        <addcharacter name="mc" animations="Edgeworth"/>
        <setanimation name="mc" animation="Idle"/>
        <setname name="mc" displayname="Adventurer"/>
        <setposition name="mc" x="10" y="160"/>
        <setvisible name="mc" visible="true" fade="0.5" wait="true"/>
        <init language="Groovy">
            monsters ["Spider", "Dragon", "Snake", "Pig"]
            gold 0
            small false
            medium false
            large false
            key false
            triedlarge false
        </init>
        <changebranch newbranch="dungeon"/>
    </branch>

    <branch name="dungeon">
        <message speaker="game">
            <text>You walk through the dungeon. The floor creaks with each step...</text>
            <text>.....................</text>
            <text>Suddenly...!</text>
        </message>
        <script language="Groovy">monster = monsters[(int) Math.floor(Math.random() * monsters.size())]</script>
        <message speaker="mc">
            <text>Ahh! No way! It's a fierce @v{Groovy_monster}! I must draw my weapon and defend myself!</text>
        </message>
        <choices>
            <choice name="Fight">
                <changebranch newbranch="success"/>
            </choice>
            <choice name="Run">
                <message speaker="mc">
                    <text>Look! 3 chests! There's a small one, a medium one, and a large one.</text>
                </message>
                <changebranch newbranch="chest"/>
            </choice>
        </choices>
    </branch>

    <branch name="success">
        <script language="Groovy">
            colors = ["Red", "Gold", "Silver"]
            color = colors[(int) Math.floor(Math.random() * colors.size())]
            amount = (int) (Math.random() * 50 + 10)
            gold += amount
        </script>
        <message speaker="mc">
            <text>Yes, I have slayed the @v{Groovy_monster}! What's this?!
                It dropped a @v{Groovy_color} key and @v{Groovy_amount} gold!</text>
            <text>I now have @v{Groovy_gold} gold!</text>
        </message>
        <script language="Groovy">
            key = true
        </script>
        <message speaker="mc">
            <text>Look! 3 chests! There's a small one, a medium one, and a large one.</text>
        </message>
        <changebranch newbranch="chest"/>
    </branch>

    <branch name="chest">
        <choices>
            <choice name="Open Small">
                <if language="Groovy">!small</if>
                <script language="Groovy">
                    amount = (int) (Math.random() * 50 + 10)
                    gold += amount
                    small = true
                </script>
                <message speaker="mc">
                    <text>It contained @v{Groovy_amount} gold! I now have @v{Groovy_gold} gold.</text>
                </message>
            </choice>
            <choice name="Open Medium">
                <if language="Groovy">!medium</if>
                <script language="Groovy">
                    amount = (int) (Math.random() * 100 + 60)
                    gold += amount
                    medium = true
                </script>
                <message speaker="mc">
                    <text>It contained @v{Groovy_amount} gold! I now have @v{Groovy_gold} gold.</text>
                </message>
            </choice>
            <choice name="Open Large">
                <if language="Groovy">!large</if>
                <script language="Groovy">triedlarge = true</script>
                <if language="Groovy">
                    !key
                    <message speaker="mc">
                        <text>The chest is locked and I don't have the key.</text>
                    </message>
                    <changebranch newbranch="loop"/>
                </if>
                <script language="Groovy">
                    amount = (int) (Math.random() * 500 + 100)
                    gold += amount
                    large = true
                </script>
                <message speaker="mc">
                    <text>It contained @v{Groovy_amount} gold! I now have @v{Groovy_gold} gold.</text>
                </message>
            </choice>
        </choices>
        <changebranch newbranch="loop"/>
    </branch>

    <branch name="loop">
        <if language="Groovy">
            <![CDATA[small && medium && large]]>
            <message speaker="mc">
                <text>Yes! I've looted all of the dungeon! I can go now!</text>
            </message>
            <message speaker="game">
                <text>And so he left with his newfound fortune to live a life of luxury!</text>
                <text>THE END</text>
            </message>
            <changebranch newbranch="end"/>
        </if>
        <if language="Groovy">
            <![CDATA[
                small && medium && !large && !key && triedlarge
            ]]>
            <message speaker="mc">
                <text>Looks like I've done all I can without a key. Should I look for it?</text>
            </message>
            <choices>
                <choice name="Look for key">
                    <changebranch newbranch="dungeon"/>
                </choice>
                <choice name="Leave dungeon">
                    <message speaker="game">
                        <text>And so he left without the key, leaving behind untold riches.</text>
                        <text>BAD ENDING.</text>
                    </message>
                    <changebranch newbranch="end"/>
                </choice>
            </choices>
        </if>
        <changebranch newbranch="chest"/>
    </branch>

    <branch name="end">
        <setvisible name="mc" visible="false" fade="2" wait="true"/>
    </branch>
</conversation>